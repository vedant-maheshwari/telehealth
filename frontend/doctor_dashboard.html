<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor Dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    /* Global resets */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #4285f4 0%, #1976d2 100%);
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    /* Tabs */
    .nav-tabs {
      display: flex;
      background: white;
      border-radius: 10px;
      margin: 30px 0 20px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    .nav-tab {
      flex: 1;
      padding: 18px 20px;
      background: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      transition: all 0.3s ease;
      text-align: center;
    }
    .nav-tab:hover {
      background: #f8f9ff;
      color: #4285f4;
    }
    .nav-tab.active {
      background: #4285f4;
      color: white;
      font-weight: 600;
    }
    .nav-tab:not(:last-child) {
      border-right: 1px solid #e8eaed;
    }
    /* Tab content fade */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid #e8eaed;
    }
    /* Welcome card */
    .welcome-card {
      text-align: center;
      padding: 32px 24px;
    }
    .welcome-card h2 {
      color: #333;
      font-size: 24px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .welcome-card p {
      color: #666;
      font-size: 16px;
      margin-bottom: 24px;
    }
    /* Buttons */
    .btn,
    .button {
      display: inline-block;
      padding: 12px 24px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.3s ease;
      margin: 5px;
    }
    .btn:hover,
    .button:hover {
      background: #3367d6;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }
    .btn-secondary {
      background: #6c757d;
    }
    .btn-secondary:hover {
      background: #545b62;
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    .btn-danger {
      background: #dc3545;
    }
    .btn-danger:hover {
      background: #c82333;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
      margin: 0;
    }
    
    /* Chat Section Styles */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    .chat-actions {
      display: flex;
      gap: 12px;
    }
    .chat-landing {
      display: block;
    }
    .chat-rooms-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .chat-rooms-container .card {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .chat-rooms-container .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      border-color: #4285f4;
    }
    .chat-rooms-container .card h4 {
      color: #333;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .chat-messages {
      display: none;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      height: 600px;
      position: relative;
    }
    .chat-header {
      background: #4285f4;
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-title {
      font-size: 18px;
      font-weight: 600;
    }
    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .messages-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 80px;
      background: #f8f9fa;
    }
    .message-bubble {
      display: flex;
      flex-direction: column;
      max-width: 70%;
      border-radius: 18px;
      padding: 12px 16px;
      word-wrap: break-word;
      position: relative;
    }
    .message-bubble.own {
      align-self: flex-end;
      background: #4285f4;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message-bubble.other {
      align-self: flex-start;
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .message-sender {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 13px;
    }
    .message-content {
      line-height: 1.4;
      margin-bottom: 4px;
    }
    .message-meta {
      font-size: 12px;
      opacity: 0.7;
      align-self: flex-end;
    }
    .chat-input-container {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      padding: 20px;
      background: white;
      border-top: 1px solid #e8eaed;
      gap: 12px;
      align-items: flex-end;
    }
    .message-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e8eaed;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
      min-height: 20px;
      max-height: 96px;
    }
    .message-input:focus {
      border-color: #4285f4;
    }
    .send-btn {
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: background 0.3s ease;
    }
    .send-btn:hover {
      background: #3367d6;
    }
    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    /* Create Room Section */
    .create-room-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e8eaed;
    }
    .create-room-card {
      background: #f8f9fa;
      padding: 24px;
      border-radius: 10px;
      border: 1px solid #e8eaed;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      animation: modalFadeIn 0.3s ease;
    }
    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes modalSlideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
      transition: color 0.3s ease;
    }
    .close:hover {
      color: #333;
    }
    .modal h2 {
      margin: 0 0 20px 0;
      font-size: 24px;
      font-weight: 600;
      color: #333;
    }
    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e8eaed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    .form-input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }
    /* Loading and State Styles */
    .loading-state,
    .empty-state,
    .error-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .loading-state::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e8eaed;
      border-radius: 50%;
      border-top-color: #4285f4;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    .availability-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.availability-card {
  background: white;
  border: 1px solid #e8eaed;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.availability-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.availability-day {
  font-size: 18px;
  font-weight: 600;
  color: #4285f4;
  margin-bottom: 10px;
}

.availability-time {
  font-size: 16px;
  color: #333;
  margin-bottom: 8px;
}

.availability-duration {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.availability-break {
  font-size: 14px;
  color: #f57c00;
  margin-bottom: 15px;
  font-style: italic;
}

.availability-actions {
  display: flex;
  gap: 10px;
}
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .empty-state h4,
    .error-state h4 {
      color: #333;
      margin-bottom: 8px;
    }
    .error-state {
      color: #dc3545;
    }
    .error-state h4 {
      color: #dc3545;
    }
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }
      .nav-tabs {
        flex-wrap: wrap;
      }
      .nav-tab {
        flex: 1 1 auto;
        min-width: 120px;
      }
      .chat-rooms-container {
        grid-template-columns: 1fr;
      }
      .modal-content {
        margin: 10% auto;
        width: 95%;
      }
      .section-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }
      .chat-actions {
        width: 100%;
      }
      .chat-messages {
        height: 500px;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header">
    <h1>Doctor Dashboard</h1>
  </div>

  <div class="container">
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('profile')">Profile</button>
      <button class="nav-tab" onclick="showTab('appointments')">Appointments</button>
      <button class="nav-tab" onclick="showTab('chats')">Chats</button>
      <button class="nav-tab" onclick="showTab('vitals')">Patient Vitals</button>
      <button class="nav-tab" onclick="showTab('availability')">Availability</button>
    </div>

    <!-- Profile Tab -->
    <div id="profile" class="tab-content active">
      <div class="card welcome-card">
        <h2>Welcome, <span id="userName">Doctor</span></h2>
        <p>Email: <span id="userEmail">doctor@example.com</span></p>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Appointments Tab -->
    <div id="appointments" class="tab-content">
      <div class="card">
        <div class="section-header">
          <h3 class="section-title">Appointment Management</h3>
        </div>
        <p style="margin-bottom: 20px; color: #666;">
          View and manage your upcoming appointments with patients.
        </p>
        <button class="btn" onclick="location.href='doctor_appointment.html'">View Appointments</button>
      </div>
    </div>

    <!-- Chats Tab -->
    <div id="chats" class="tab-content">
      <!-- Chat Landing - List of Rooms -->
      <div id="chatLanding" class="chat-landing">
        <div class="card">
          <div class="section-header">
            <h3 class="section-title">Your Chat Rooms</h3>
            <div class="chat-actions">
              <button class="btn btn-secondary" onclick="loadChats()">Refresh</button>
              <button class="btn" onclick="showChatMessages()" id="showRoomsBtn">
                Show Chat Messages
              </button>
              <button class="btn" onclick="showCreateSection()" id="createToggleBtn">Create Room</button>
            </div>
          </div>

          <div id="chatRoomsDiv" class="chat-rooms-container">
            <div class="loading-state">Loading chat rooms...</div>
          </div>

          <!-- Create Room Section -->
          <div id="createSection" class="create-room-section" style="display: none;">
            <div class="create-room-card">
              <h3 style="color: #333; margin-bottom: 16px;">Create Chat Room</h3>
              <div class="form-group">
                <label class="form-label">Room Name:</label>
                <input
                  type="text"
                  id="roomName"
                  placeholder="e.g., John's Consultation"
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label class="form-label"
                  >Participant Emails (comma-separated):</label
                >
                <input
                  type="text"
                  id="participantEmails"
                  placeholder="e.g., patient@example.com, family@example.com"
                  class="form-input"
                />
              </div>
              <div
                style="display: flex; gap: 12px; justify-content: flex-end"
              >
                <button class="btn btn-secondary" onclick="hideCreateSection()">
                  Cancel
                </button>
                <button class="btn" onclick="createRoom()">Create Room</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Messages Interface -->
      <div id="chatMessages" class="chat-messages">
        <div class="chat-header">
          <div id="chatTitle" class="chat-title">Chat Room</div>
          <button class="back-btn" onclick="showChatLanding()">← Back to Chats</button>
        </div>
        <div id="messagesDiv" class="messages-container">
          <div class="loading-state">Loading messages...</div>
        </div>
        <div class="chat-input-container">
          <textarea
            id="txt"
            class="message-input"
            placeholder="Type your message..."
            rows="1"
          ></textarea>
          <button id="sendBtn" class="send-btn">➤</button>
        </div>
      </div>
    </div>

    <!-- Patient Vitals Tab -->
    <div id="vitals" class="tab-content">
      <div class="card">
        <div class="section-header">
          <h3 class="section-title">Patient Vitals Management</h3>
        </div>
        <p style="margin-bottom: 20px; color: #666;">
          Record and track vital signs for your patients.
        </p>
        <button class="btn" onclick="openVitalsModal()">Add Patient Vitals</button>
      </div>
    </div>

    <!-- Availability Tab -->
    <div id="availability" class="tab-content">
      <div class="card">
        <div class="section-header">
          <h3 class="section-title">Set Your Availability</h3>
          <button class="btn" onclick="openAvailabilityModal()">
            Add Availability
          </button>
        </div>
        <div id="availabilityList" class="empty-state">Loading availability...</div>
      </div>
    </div>
  </div>

  <!-- Vitals Modal -->
  <div id="vitalsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeVitalsModal()">&times;</span>
      <h2>Add Patient Vitals</h2>

      <div class="form-group">
        <label class="form-label">Patient Email:</label>
        <input
          type="email"
          class="form-input"
          id="vitalEmail"
          placeholder="patient@example.com"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Blood Pressure (Systolic):</label>
        <input
          type="number"
          class="form-input"
          id="vitalBP"
          placeholder="e.g. 120"
          min="50"
          max="250"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Heart Rate (BPM):</label>
        <input
          type="number"
          class="form-input"
          id="vitalHeartRate"
          placeholder="e.g. 72"
          min="30"
          max="200"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Temperature (°F):</label>
        <input
          type="number"
          class="form-input"
          id="vitalTemp"
          placeholder="e.g. 98.6"
          min="90"
          max="110"
          step="0.1"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Notes (Optional):</label>
        <input
          type="text"
          class="form-input"
          id="vitalNotes"
          placeholder="Any additional notes"
        />
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeVitalsModal()">
          Cancel
        </button>
        <button class="btn" id="submitVitalsBtn">Submit Vitals</button>
      </div>
    </div>
  </div>

  <div id="availability" class="tab-content">
  <div class="card">
    <div class="section-header">
      <h3 class="section-title">Set Your Availability</h3>
      <button class="btn" onclick="openAvailabilityModal()">
        Add Availability
      </button>
    </div>
    <div id="availabilityList" class="empty-state">Loading availability...</div>
  </div>
</div>

  <!-- Availability Modal -->
  <div id="availabilityModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAvailabilityModal()">&times;</span>
      <h2>Set Availability</h2>

      <div class="form-group">
        <label class="form-label">Day of Week</label>
        <select id="availDay" class="form-input">
          <option value="0">Sunday</option>
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Start Time</label>
        <input type="time" id="availStart" class="form-input" />
      </div>

      <div class="form-group">
        <label class="form-label">End Time</label>
        <input type="time" id="availEnd" class="form-input" />
      </div>

      <div class="form-group">
        <label class="form-label">Appointment Duration (minutes)</label>
        <input
          type="number"
          id="availDuration"
          class="form-input"
          min="1"
          value="30"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Break Start (optional)</label>
        <input type="time" id="availBreakStart" class="form-input" />
      </div>

      <div class="form-group">
        <label class="form-label">Break End (optional)</label>
        <input type="time" id="availBreakEnd" class="form-input" />
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeAvailabilityModal()">
          Cancel
        </button>
        <button class="btn" id="saveAvailBtn">Save Availability</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const API_BASE_URL = API_CONFIG.getApiBaseUrl();

    const token =
      sessionStorage.getItem("token") || localStorage.getItem("authToken");
    const role = sessionStorage.getItem("role") || localStorage.getItem("userRole");

    // Chat variables
    let currentChatId = null;
    let wsClient = null;
    let lastSenderId = null;

    // DOM elements
    const chatLanding = document.getElementById("chatLanding");
    const chatMessages = document.getElementById("chatMessages");
    const chatRoomsDiv = document.getElementById("chatRoomsDiv");
    const showRoomsBtn = document.getElementById("showRoomsBtn");
    const chatTitle = document.getElementById("chatTitle");
    const messagesDiv = document.getElementById("messagesDiv");
    const txt = document.getElementById("txt");
    const sendBtn = document.getElementById("sendBtn");

    // Tab switching functionality
    function showTab(tabName) {
      const tabContents = document.querySelectorAll(".tab-content");
      tabContents.forEach((content) => content.classList.remove("active"));

      const tabs = document.querySelectorAll(".nav-tab");
      tabs.forEach((tab) => tab.classList.remove("active"));

      document.getElementById(tabName).classList.add("active");

      event.target.classList.add("active");

      if (tabName === "chats") {
        loadChats();
        showChatLanding();
      } else if (tabName === "availability") {
        loadAvailability();
      }

      if (tabName !== "chats" && wsClient) {
        wsClient.close();
        wsClient = null;
      }
    }

    async function loadUser() {
      if (!token) {
        window.location.href = "login.html";
        return;
      }
      try {
        const res = await fetch(`${API_BASE_URL}/user/me`, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) throw new Error("Unauthorized");
        const user = await res.json();
        sessionStorage.setItem("user_id", user.id);
        document.getElementById("userName").textContent = user.name;
        document.getElementById("userEmail").textContent = user.email;
      } catch (err) {
        console.error("Load user error:", err);
        sessionStorage.clear();
        alert("Please login again");
        window.location.href = "login.html";
      }
    }

    // Chat Functions
    async function loadChats() {
      chatRoomsDiv.innerHTML = '<div class="loading-state">Loading chat rooms...</div>';
      try {
        const res = await fetch(`${API_BASE_URL}/chats/my`, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const chats = await res.json();
        chatRoomsDiv.innerHTML = "";

        if (!Array.isArray(chats) || chats.length === 0) {
          chatRoomsDiv.innerHTML = `
            <div class="empty-state">
              <h4>No chat rooms found</h4>
              <p>Create a new chat room to start communicating with patients.</p>
            </div>
          `;
          return;
        }

        chats.forEach((c) => {
          const div = document.createElement("div");
          div.className = "card";

          const title = document.createElement("h4");
          title.textContent = c.name || "Chat Room";

          const button = document.createElement("button");
          button.className = "button";
          button.textContent = "Open";

          button.addEventListener("click", () => {
            openChat(c.id, c.name || "Chat Room");
          });

          div.appendChild(title);
          div.appendChild(button);
          chatRoomsDiv.appendChild(div);
        });
      } catch (error) {
        console.error("Error loading chats:", error);
        chatRoomsDiv.innerHTML = `
          <div class="error-state">
            <h4>Error loading chat rooms</h4>
            <p>Please check your connection and try again.</p>
            <button class="button" onclick="loadChats()" style="margin-top: 1rem;">Retry</button>
          </div>
        `;
      }
    }

    function showChatLanding() {
      chatLanding.style.display = "block";
      chatMessages.style.display = "none";
      showRoomsBtn.textContent = "Show Chat Messages";
      lastSenderId = null;
    }

    function showChatMessages() {
      chatLanding.style.display = "none";
      chatMessages.style.display = "flex";
      showRoomsBtn.textContent = "Show All Chats";
    }

    window.openChat = async function (id, name) {
      currentChatId = id;
      chatTitle.textContent = name;
      showChatMessages();
      lastSenderId = null;
      await loadHistory();
      await connectWS();
    };

    async function loadHistory() {
      messagesDiv.innerHTML = '<div class="loading-state">Loading messages...</div>';
      try {
        const res = await fetch(`${API_BASE_URL}/chats/${currentChatId}/messages`, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const msgs = await res.json();
        messagesDiv.innerHTML = "";
        if (msgs.length === 0) {
          messagesDiv.innerHTML = `
            <div class="empty-state">
              <h4>Start the conversation</h4>
              <p>Send a message to begin chatting</p>
            </div>
          `;
        } else {
          msgs.forEach(showMessage);
        }
      } catch (error) {
        console.error("Error loading history:", error);
        messagesDiv.innerHTML = '<div class="error-state"><h4>Failed to load messages</h4></div>';
      }
    }

    function showMessage(msg) {
      const existingState = messagesDiv.querySelector(".loading-state, .empty-state");
      if (existingState) {
        existingState.remove();
      }

      const own = Number(msg.sender_id) === Number(sessionStorage.getItem("user_id"));
      const showSender = msg.sender_id !== lastSenderId;
      lastSenderId = msg.sender_id;

      const bubble = document.createElement("div");
      bubble.className = "message-bubble " + (own ? "own" : "other");

      let ts = "now";
      try {
        ts = new Date(msg.timestamp).toLocaleString([], {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
          day: "numeric",
          month: "short",
        });
      } catch (e) {}

      const senderName = msg.sender_name || `User ${msg.sender_id}`;

      bubble.innerHTML = `
        ${
          !own && showSender
            ? `<div class="message-sender" style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(
                senderName
              )}</div>`
            : ""
        }
        <div class="message-content">${escapeHtml(msg.content)}</div>
        <div class="message-meta">${ts}</div>
      `;

      messagesDiv.appendChild(bubble);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, (m) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
    }

    async function connectWS() {
      if (wsClient) {
        wsClient.close();
      }
      try {
        const res = await fetch(`${API_BASE_URL}/ws-token`, {
          method: "POST",
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { ws_token } = await res.json();

        let wsUrl;
        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
          wsUrl = `ws://127.0.0.1:8000/chats/ws/${currentChatId}?ws_token=${ws_token}`;
        } else {
          wsUrl = `wss://${window.location.host}/chats/ws/${currentChatId}?ws_token=${ws_token}`;
        }

        wsClient = new WebSocket(wsUrl);

        sendBtn.disabled = true;

        wsClient.onopen = () => {
          sendBtn.disabled = false;
          console.log("WebSocket connected");
        };
        wsClient.onmessage = (ev) => {
          const msg = JSON.parse(ev.data);
          showMessage(msg);
        };
        wsClient.onerror = (error) => {
          console.error("WebSocket error:", error);
        };
        wsClient.onclose = (event) => {
          console.log(`WebSocket closed: ${event.code} - ${event.reason}`);
          sendBtn.disabled = true;
        };
      } catch (err) {
        console.error("Error connecting WebSocket:", err);
        sendBtn.disabled = true;
      }
    }

    txt.addEventListener("input", () => {
      txt.style.height = "auto";
      txt.style.height = Math.min(txt.scrollHeight, 96) + "px";
      sendBtn.disabled = !txt.value.trim() || !wsClient || wsClient.readyState !== WebSocket.OPEN;
    });

    sendBtn.addEventListener("click", sendMessage);
    txt.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function sendMessage() {
      if (!wsClient || wsClient.readyState !== WebSocket.OPEN) return;
      const text = txt.value.trim();
      if (!text) return;

      try {
        wsClient.send(JSON.stringify({ content: text }));
        txt.value = "";
        txt.style.height = "auto";
        sendBtn.disabled = true;
      } catch (error) {
        console.error("Error sending message:", error);
      }
    }

    // Create Room Functions
    function showCreateSection() {
      const createSection = document.getElementById("createSection");
      const isVisible = createSection.style.display !== "none";
      createSection.style.display = isVisible ? "none" : "block";

      const btn = document.getElementById("createToggleBtn");
      btn.textContent = isVisible ? "Create Room" : "Hide Create";
    }

    function hideCreateSection() {
      document.getElementById("createSection").style.display = "none";
      document.getElementById("createToggleBtn").textContent = "Create Room";

      document.getElementById("roomName").value = "";
      document.getElementById("participantEmails").value = "";
    }

    async function createRoom() {
      const name = document.getElementById("roomName").value.trim();
      const emailsRaw = document.getElementById("participantEmails").value.trim();

      if (!name || !emailsRaw) {
        alert("Please fill in room name and participant emails");
        return;
      }

      const participant_emails = emailsRaw
        .split(",")
        .map((email) => email.trim())
        .filter((email) => email.includes("@"));

      if (participant_emails.length === 0) {
        alert("Please provide valid email addresses");
        return;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/chats/create`, {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ name, participant_emails }),
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
          alert("Failed to create chat room: " + (error.detail || res.status));
          return;
        }

        await res.json();
        alert("Chat room created successfully!");

        hideCreateSection();

        loadChats();
      } catch (err) {
        console.error("Error creating chat room:", err);
        alert("Error creating chat room. Please try again.");
      }
    }

    // Vitals functions
    function openVitalsModal() {
      document.getElementById("vitalsModal").style.display = "block";
    }
    function closeVitalsModal() {
      document.getElementById("vitalsModal").style.display = "none";

      [
        "vitalEmail",
        "vitalBP",
        "vitalHeartRate",
        "vitalTemp",
        "vitalNotes",
      ].forEach((id) => {
        document.getElementById(id).value = "";
      });
    }

    document.getElementById("submitVitalsBtn").addEventListener("click", async () => {
      const email = document.getElementById("vitalEmail").value.trim();
      const bp = document.getElementById("vitalBP").value.trim();
      const heartRate = document.getElementById("vitalHeartRate").value.trim();
      const temperature = document.getElementById("vitalTemp").value.trim();
      const notes = document.getElementById("vitalNotes").value.trim();

      if (!email || !email.includes("@")) {
        alert("Please enter a valid patient email");
        return;
      }

      if (!bp && !heartRate && !temperature) {
        alert("Please enter at least one vital measurement");
        return;
      }

      const vitalData = {
        patient_email: email,
        bp: bp ? parseInt(bp) : null,
        heart_rate: heartRate ? parseInt(heartRate) : null,
        temperature: temperature ? parseFloat(temperature) : null,
        notes: notes || null,
      };

      try {
        const res = await fetch(`${API_BASE_URL}/add-vital`, {
          method: "POST",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(vitalData),
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
          alert("Failed to add vitals: " + (error.detail || res.status));
          return;
        }

        await res.json();
        alert("Patient vitals added successfully!");
        closeVitalsModal();
      } catch (err) {
        console.error("Error adding vitals:", err);
        alert("Error adding vitals. Please try again.");
      }
    });

    // Availability modal
    function openAvailabilityModal() {
      document.getElementById("availabilityModal").style.display = "block";
    }
    function closeAvailabilityModal() {
      document.getElementById("availabilityModal").style.display = "none";

      [
        "availDay",
        "availStart",
        "availEnd",
        "availDuration",
        "availBreakStart",
        "availBreakEnd",
      ].forEach((id) => {
        if(document.getElementById(id)) document.getElementById(id).value = "";
      });
    }

    // Load availability
    // Load availability with better UI
async function loadAvailability() {
  try {
    const res = await fetch(`${API_BASE_URL}/doctor/availability`, {
      headers: { Authorization: "Bearer " + token },
    });
    if (!res.ok) throw new Error("Failed to load availability");
    const data = await res.json();
    const availabilities = data.availabilities || [];
    const container = document.getElementById("availabilityList");

    if (!availabilities || availabilities.length === 0) {
      container.innerHTML = '<div class="empty-state"><h4>No availability set</h4><p>Click "Add Availability" to set your working hours</p></div>';
      return;
    }

    const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    
    container.innerHTML = '<div class="availability-grid">' + availabilities.map((a) => {
      return `
        <div class="availability-card">
          <div class="availability-day">${daysOfWeek[a.day_of_week]}</div>
          <div class="availability-time">🕐 ${a.start_time} - ${a.end_time}</div>
          <div class="availability-duration">⏱️ ${a.appointment_duration} minutes per appointment</div>
          ${a.break_start ? `<div class="availability-break">☕ Break: ${a.break_start} - ${a.break_end}</div>` : ''}
          <div class="availability-actions">
            <button class="btn btn-danger btn-sm" onclick="deleteAvail(${a.id})">Delete</button>
          </div>
        </div>
      `;
    }).join("") + '</div>';
  } catch (err) {
    console.error("Error loading availability", err);
    document.getElementById("availabilityList").innerHTML = '<div class="error-state"><h4>Error loading availability</h4><p>Failed to load availability settings</p></div>';
  }
}


    // Save availability
//     document.getElementById("saveAvailBtn").addEventListener("click", async () => {
//   const startTime = document.getElementById("availStart").value;
//   const endTime = document.getElementById("availEnd").value;
//   const duration = document.getElementById("availDuration").value;

//   if (!startTime || !endTime || !duration) {
//     alert("Please fill in all required fields");
//     return;
//   }

//   const payload = {
//     availabilities: [{
//       day_of_week: parseInt(document.getElementById("availDay").value),
//       start_time: startTime,
//       end_time: endTime,
//       appointment_duration: parseInt(duration),
//       break_start: document.getElementById("availBreakStart").value || null,
//       break_end: document.getElementById("availBreakEnd").value || null,
//     }]
//   };

//   try {
//     const res = await fetch(`${API_BASE_URL}/doctor/availability`, {
//       method: "POST",
//       headers: {
//         Authorization: "Bearer " + token,
//         "Content-Type": "application/json",
//       },
//       body: JSON.stringify(payload),
//     });

//     if (!res.ok) {
//       const error = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
//       throw new Error(error.detail || "Failed to save availability");
//     }

//     alert("Availability saved successfully!");
//     closeAvailabilityModal();
//     await loadAvailability();
//   } catch (err) {
//     console.error("Error saving availability:", err);
//     alert(err.message || "Error saving availability");
//   }
// });

async function saveAvailability() {
  const availabilityPayload = {
    day_of_week: parseInt(document.getElementById("availDay").value),
    start_time: document.getElementById("availStart").value,
    end_time: document.getElementById("availEnd").value,
    appointment_duration: parseInt(document.getElementById("availDuration").value),
    break_start: document.getElementById("availBreakStart").value || null,
    break_end: document.getElementById("availBreakEnd").value || null,
  };

  try {
    const res = await fetch(`${API_BASE_URL}/doctor/availability`, {
      method: "PUT",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(availabilityPayload),
    });
    if (!res.ok) throw new Error("Failed to update availability");
    alert("Availability updated successfully.");
    closeAvailabilityModal();
    await loadAvailability();
  } catch (err) {
    alert(err.message || "Error updating availability");
  }
}

document.getElementById("saveAvailBtn").addEventListener("click", saveAvailability);


document.getElementById("saveAvailBtn").addEventListener("click", saveAvailability);


    // Delete availability
    async function deleteAvail(id) {
  if (!confirm("Are you sure you want to delete this availability?")) {
    return;
  }

  try {
    const res = await fetch(`${API_BASE_URL}/doctor/availability/${id}`, {
      method: "DELETE",
      headers: { Authorization: "Bearer " + token },
    });
    
    if (!res.ok) {
      const error = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
      throw new Error(error.detail || "Failed to delete availability");
    }
    
    alert("Availability deleted successfully!");
    await loadAvailability();
  } catch (err) {
    console.error("Error deleting availability:", err);
    alert(err.message || "Error deleting availability");
  }
}

    // Close modals when clicking outside
    window.onclick = function (event) {
      const modals = document.querySelectorAll(".modal");
      modals.forEach((modal) => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });
    };

    // Logout
    function logout() {
      if (wsClient) {
        wsClient.close();
        wsClient = null;
      }
      sessionStorage.clear();
      localStorage.clear();
      window.location.href = "login.html";
    }

    // Initialize
    document.addEventListener("DOMContentLoaded", function () {
      loadUser();
    });
  </script>
</body>
</html>
