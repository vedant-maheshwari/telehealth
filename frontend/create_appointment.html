<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Appointment Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select, button {
      padding: 10px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    select, input[type="date"] {
      width: calc(100% - 10px);
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .slot {
      padding: 10px 15px;
      margin: 5px;
      border: 2px solid #007bff;
      cursor: pointer;
      display: inline-block;
      border-radius: 6px;
      background-color: #f8f9fa;
      transition: all 0.3s ease;
    }
    .slot:hover {
      background-color: #e9ecef;
    }
    .slot.reserved {
      background-color: #dc3545;
      color: white;
      border-color: #dc3545;
      cursor: not-allowed;
    }
    .slot.selected {
      background-color: #28a745;
      color: white;
      border-color: #28a745;
    }
    .slots-container {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 100px;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .actions {
      margin-top: 15px;
    }
    .websocket-status {
      padding: 5px 10px;
      border-radius: 4px;
      margin-left: 10px;
      font-size: 12px;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    .user-info {
      background-color: #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .booking-for {
      background-color: #fff3cd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #ffc107;
    }

    /* Modal styles */
    .modal { 
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      z-index: 9999;
    }
    .modal-content { 
      background: white; 
      margin: 10% auto; 
      padding: 20px; 
      width: 320px; 
      border-radius: 8px; 
      text-align: center; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content button {
      margin: 8px;
      min-width: 100px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Doctor Appointment Booking</h1>
    
    <!-- User Information Display -->
    <div id="userInfo" class="user-info">
      <h3>Loading user information...</h3>
    </div>

    <!-- Booking For Information (if family member) -->
    <div id="bookingFor" class="booking-for" style="display: none;">
      <strong>Booking appointment for:</strong> <span id="patientName"></span>
    </div>
    
    <div class="form-group">
      <label for="doctorSelect">Select Doctor:</label>
      <select id="doctorSelect">
        <option value="">Loading doctors...</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="dateInput">Date:</label>
      <input id="dateInput" type="date" />
    </div>

    <div class="form-group">
      <button id="loadSlotsBtn">Load Available Slots</button>
      <span id="wsStatus" class="websocket-status disconnected">WebSocket: Disconnected</span>
    </div>

    <div class="slots-container">
      <h3>Available Time Slots:</h3>
      <div id="slotsContainer">
        <p>Select a doctor and date to see available appointments</p>
      </div>
    </div>

    <div class="actions">
      <button id="reserveBtn" disabled>Reserve Selected Slot</button>
      <button id="confirmBtn" disabled>Confirm Reservation</button>
      <button id="cancelBtn" disabled>Cancel Reservation</button>
    </div>

    <div id="statusMessage" class="status"></div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <p>Slot <span id="modalTime"></span> is reserved for you. What would you like to do?</p>
      <button id="modalConfirmBtn">Confirm Booking</button>
      <button id="modalCancelBtn">Cancel Reservation</button>
      <button id="modalCloseBtn">Close</button>
    </div>
  </div>

  <script>
    // Environment-aware API URL
    const getApiBaseUrl = () => {
      if (window.location.hostname.includes('azurewebsites.net')) {
        return window.location.origin;
      }
      return "http://localhost:8000";
    };

    const API_BASE_URL = getApiBaseUrl();
    const API_BASE_URL_WS = window.location.hostname.includes('azurewebsites.net') 
      ? window.location.host 
      : "localhost:8000";

    const token = sessionStorage.getItem("token") || localStorage.getItem("token");
    
    if (!token) {
      alert("You must be logged in!");
      window.location.href = "login.html";
    }

    let wsConnection = null;
    let selectedSlot = null;
    let selectedDoctorId = null;
    let selectedDate = null;
    let currentUser = null;
    let bookingForPatient = null; // For family members booking for patients
    let ownReservedKey = null;

    // DOM elements
    const slotsContainer = document.getElementById('slotsContainer');
    const doctorSelect = document.getElementById('doctorSelect');
    const dateInput = document.getElementById('dateInput');
    const loadSlotsBtn = document.getElementById('loadSlotsBtn');
    const reserveBtn = document.getElementById('reserveBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const statusMessage = document.getElementById('statusMessage');
    const wsStatus = document.getElementById('wsStatus');
    const userInfo = document.getElementById('userInfo');
    const bookingForDiv = document.getElementById('bookingFor');
    const patientNameSpan = document.getElementById('patientName');

    // Modal elements
    const modal = document.getElementById('confirmModal');
    const modalTime = document.getElementById('modalTime');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    // Set default date to today
    const today = new Date();
    dateInput.value = today.toISOString().split('T')[0];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCurrentUser();
      await loadDoctors();
      checkForFamilyBooking();
    });

    function showStatus(message, isError = false) {
      statusMessage.textContent = message;
      statusMessage.className = `status ${isError ? 'error' : 'success'}`;
      statusMessage.style.display = 'block';
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    async function fetchWithAuth(url, options = {}) {
      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      };
      
      try {
        const response = await fetch(url, { ...options, headers: defaultOptions.headers });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `HTTP ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        showStatus(`Error: ${error.message}`, true);
        throw error;
      }
    }

    async function loadCurrentUser() {
      try {
        currentUser = await fetchWithAuth(`${API_BASE_URL}/user/me`);
        
        userInfo.innerHTML = `
          <h3>üë§ ${currentUser.name}</h3>
          <p><strong>Email:</strong> ${currentUser.email}</p>
          <p><strong>Role:</strong> ${currentUser.role}</p>
        `;
      } catch (error) {
        console.error('Failed to load user:', error);
        userInfo.innerHTML = '<h3>‚ùå Failed to load user information</h3>';
      }
    }

    async function loadDoctors() {
      try {
        const doctors = await fetchWithAuth(`${API_BASE_URL}/all_doctors`);
        
        doctorSelect.innerHTML = '<option value="">-- Select Doctor --</option>';
        doctors.forEach(doctor => {
          const option = document.createElement('option');
          option.value = doctor.id;
          option.textContent = `Dr. ${doctor.name}${doctor.medical_license ? ' (' + doctor.medical_license + ')' : ''}`;
          doctorSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load doctors:', error);
        doctorSelect.innerHTML = '<option value="">‚ùå Failed to load doctors</option>';
      }
    }

    function checkForFamilyBooking() {
      const bookingData = sessionStorage.getItem('bookingForPatient');
      if (bookingData) {
        try {
          bookingForPatient = JSON.parse(bookingData);
          bookingForDiv.style.display = 'block';
          patientNameSpan.textContent = bookingForPatient.patientName;
          
          // Clear the session storage
          sessionStorage.removeItem('bookingForPatient');
        } catch (error) {
          console.error('Error parsing booking data:', error);
        }
      }
    }

    function createSlotElement(time) {
      const el = document.createElement('div');
      el.textContent = time;
      el.className = 'slot';
      el.dataset.time = time;
      const key = `${selectedDoctorId}:${selectedDate}T${time}`;
      el.dataset.key = key;
      el.onclick = () => handleSlotClick(el, key);
      return el;
    }

    async function loadSlots() {
      selectedDoctorId = parseInt(doctorSelect.value);
      selectedDate = dateInput.value;

      if (!selectedDoctorId || !selectedDate) {
        showStatus('Please select a doctor and date', true);
        return;
      }

      try {
        const url = `${API_BASE_URL}/available_appointment?doctor_id=${selectedDoctorId}&app_date=${selectedDate}`;
        const slots = await fetchWithAuth(url);

        slotsContainer.innerHTML = "<h3>Available Time Slots:</h3>";
        selectedSlot = null;
        ownReservedKey = null;
        disableActionButtons();

        if (slots.length === 0) {
          slotsContainer.innerHTML += "<p>No slots available for this date</p>";
        } else {
          slots.forEach(time => {
            const slotEl = createSlotElement(time);
            slotsContainer.appendChild(slotEl);
          });
        }

        setupWebSocket(selectedDoctorId);
        showStatus(`Loaded ${slots.length} available slots`);
      } catch (error) {
        console.error('Failed to load slots:', error);
      }
    }

    function setupWebSocket(doctorId) {
      if (wsConnection) {
        wsConnection.close();
      }

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${API_BASE_URL_WS}/ws/doctor/${doctorId}/slots`;

      wsConnection = new WebSocket(wsUrl);

      wsConnection.onopen = () => {
        wsStatus.textContent = 'WebSocket: Connected';
        wsStatus.className = 'websocket-status connected';
        console.log('WebSocket connected');
      };

      wsConnection.onclose = () => {
        wsStatus.textContent = 'WebSocket: Disconnected';
        wsStatus.className = 'websocket-status disconnected';
        console.log('WebSocket disconnected');
      };

      wsConnection.onerror = (error) => {
        showStatus('WebSocket connection error', true);
        console.error('WebSocket error:', error);
      };

      wsConnection.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('WebSocket message:', data);

          if (data.doctor_id !== doctorId) return;

          const slotTime = data.slot_time.substr(11, 8);
          const key = `${doctorId}:${data.slot_time}`;
          const slotEl = [...slotsContainer.children].find(el => el.dataset && el.dataset.time === slotTime);

          if (!slotEl) return;

          if (data.action === "reserved") {
            slotEl.classList.add('reserved');
            if (slotEl === selectedSlot && ownReservedKey !== key) {
              selectedSlot.classList.remove('selected');
              selectedSlot = null;
              disableActionButtons();
            }
            showStatus(`Slot ${slotTime} was reserved by another user`);
          } else if (data.action === "freed") {
            slotEl.classList.remove('reserved');
            showStatus(`Slot ${slotTime} is now available`);
          }
        } catch (error) {
          console.error('Error processing WebSocket message:', error);
        }
      };
    }

    function disableActionButtons() {
      reserveBtn.disabled = true;
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
    }

    function handleSlotClick(el, key) {
      if (el.classList.contains('reserved') && ownReservedKey !== key) {
        showStatus('This slot is already reserved', true);
        return;
      }

      if (ownReservedKey === key) {
        modalTime.textContent = el.dataset.time;
        modal.style.display = 'block';

        modalConfirmBtn.onclick = () => { confirmSlot(); modal.style.display = 'none'; };
        modalCancelBtn.onclick = () => { cancelSlot(); modal.style.display = 'none'; };
        modalCloseBtn.onclick = () => { modal.style.display = 'none'; };
        return;
      }

      if (selectedSlot) selectedSlot.classList.remove('selected');
      el.classList.add('selected');
      selectedSlot = el;

      reserveBtn.disabled = false;
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
    }

    async function reserveSlot() {
      if (!selectedSlot) {
        showStatus('Please select a slot first', true);
        return;
      }

      const appointmentDateTime = `${selectedDate}T${selectedSlot.dataset.time}`;
      const appointment = {
        doctor_id: selectedDoctorId,
        appointment_date: appointmentDateTime
      };

      // Determine user ID: if family booking for patient, use patient ID; otherwise use current user ID
      const userId = bookingForPatient ? bookingForPatient.patientId : currentUser.id;

      try {
        const url = `${API_BASE_URL}/reserve_slot?user_id=${userId}`;
        const result = await fetchWithAuth(url, {
          method: 'POST',
          body: JSON.stringify(appointment)
        });

        ownReservedKey = `${selectedDoctorId}:${appointmentDateTime}`;
        const bookingText = bookingForPatient ? ` for ${bookingForPatient.patientName}` : '';
        showStatus(`Slot reserved${bookingText}! Expires in ${result.expires_in} seconds`);

        selectedSlot.classList.add('reserved');
        selectedSlot.classList.remove('selected');

        modalTime.textContent = selectedSlot.dataset.time;
        modal.style.display = 'block';
        disableActionButtons();

        selectedSlot = null;
      } catch (error) {
        console.error('Failed to reserve slot:', error);
      }
    }

    async function confirmSlot() {
      if (!ownReservedKey) {
        showStatus('No reserved slot to confirm', true);
        return;
      }

      const colonIndex = ownReservedKey.indexOf(':');
      const doctorId = ownReservedKey.substring(0, colonIndex);
      let appointmentDateTime = ownReservedKey.substring(colonIndex + 1);

      // Fix datetime format if needed
      if (appointmentDateTime.length < 19) {
        if (appointmentDateTime.length === 16) {
          appointmentDateTime += ":00";
        } else if (appointmentDateTime.length === 13) {
          appointmentDateTime += ":00:00";
        }
      }

      const appointment = {
        doctor_id: Number(doctorId),
        appointment_date: appointmentDateTime
      };

      const userId = bookingForPatient ? bookingForPatient.patientId : currentUser.id;

      try {
        const url = `${API_BASE_URL}/confirm_slot?user_id=${userId}`;
        await fetchWithAuth(url, {
          method: 'POST',
          body: JSON.stringify(appointment)
        });

        const bookingText = bookingForPatient ? ` for ${bookingForPatient.patientName}` : '';
        showStatus(`Booking confirmed successfully${bookingText}!`);
        ownReservedKey = null;
        modal.style.display = 'none';
        
        // If family member, redirect back to family dashboard
        if (bookingForPatient) {
          setTimeout(() => {
            window.location.href = 'family_dashboard.html';
          }, 2000);
        } else {
          setTimeout(loadSlots, 1000);
        }
      } catch (error) {
        console.error('Failed to confirm slot:', error);
      }
    }

    async function cancelSlot() {
      if (!ownReservedKey) {
        showStatus('No reserved slot to cancel', true);
        return;
      }

      if (!confirm('Are you sure you want to cancel this reservation?')) return;

      const colonIndex = ownReservedKey.indexOf(':');
      const doctorId = ownReservedKey.substring(0, colonIndex);
      const appointmentDateTime = ownReservedKey.substring(colonIndex + 1);
      const userId = bookingForPatient ? bookingForPatient.patientId : currentUser.id;

      try {
        const url = `${API_BASE_URL}/cancel_slot?doctor_id=${doctorId}&slot_time=${encodeURIComponent(appointmentDateTime)}&user_id=${userId}`;
        await fetchWithAuth(url, { method: 'POST' });

        showStatus('Reservation cancelled successfully');
        ownReservedKey = null;
        modal.style.display = 'none';
        setTimeout(loadSlots, 1000);
      } catch (error) {
        console.error('Failed to cancel slot:', error);
      }
    }

    // Event listeners
    loadSlotsBtn.onclick = loadSlots;
    reserveBtn.onclick = reserveSlot;
    confirmBtn.onclick = confirmSlot;
    cancelBtn.onclick = cancelSlot;

    // Close modal when clicking outside
    window.onclick = (event) => {
      if (event.target === modal) modal.style.display = 'none';
    };
  </script>
</body>
</html>
