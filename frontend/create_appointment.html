<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Appointment Booking</title>
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(110deg, #e3f2fd 0%, #f5f5f5 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 36px auto 20px auto;
      background: #fff;
      padding: 42px 36px 30px 36px;
      border-radius: 16px;
      box-shadow: 0 6px 32px rgba(66,133,244,0.10);
    }
    .step-title {
      font-size: 22px;
      font-weight: 900;
      color: #1976d2;
      margin-bottom: 18px;
      letter-spacing: 0;
    }
    label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .form-group {
      margin-bottom: 30px;
    }
    input, select {
      font-size: 16px;
      padding: 12px 16px;
      border: 2px solid #e3e6ea;
      border-radius: 8px;
      width: 100%;
      outline: none;
      background: #f7fafc;
      margin-top: 4px;
      transition: border-color .2s;
    }
    input:focus, select:focus {
      border-color: #1976d2;
      background: #fff;
    }
    button {
      padding: 12px 26px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      margin: 5px;
      box-shadow: 0 1px 6px #1976d22c;
      cursor: pointer;
      transition: background .18s;
    }
    button:hover:enabled {
      background: #1564b0;
    }
    button:disabled {
      background: #bfc8d5;
      cursor: not-allowed;
    }

    /* User Info & Card-Style Accent Boxes */
    .user-info {
      background-color: #e3e7ea;
      border-left: 4px solid #4285f4;
      padding: 18px 22px;
      border-radius: 8px;
      margin-bottom: 18px;
      font-size: 17px;
      color: #125ea2;
      box-shadow: 0 2px 8px #c7dcfa24;
    }
    .booking-for {
      background-color: #fffbe7;
      border-left: 5px solid #ffca28;
      padding: 12px 18px;
      border-radius: 6px;
      margin-bottom: 15px;
      color: #996800;
      font-size: 16px;
      font-weight: 600;
    }
    .slots-container {
      margin-top: 16px;
      padding: 16px 18px 8px 18px;
      border: 1.5px solid #e3e6ea;
      border-radius: 8px;
      min-height: 120px;
      background: #f9fcff;
      box-shadow: 0 1px 8px #2057920e;
    }
    .slot {
      padding: 12px 26px;
      margin: 8px 12px 8px 0;
      border: 2px solid #1976d2;
      cursor: pointer;
      display: inline-block;
      border-radius: 99px;
      background-color: #f1fafe;
      font-size: 16px;
      font-weight: 600;
      transition: 
        background .2s, 
        color .2s, 
        box-shadow .2s, 
        border .2s, 
        transform .15s;
      box-shadow: 0 2px 8px #1976d225;
      user-select: none;
      position: relative;
    }
    .slot:hover:not(.reserved):not(.selected) {
      background: #e3f0fc;
      transform: translateY(-2px) scale(1.04);
    }
    .slot.selected {
      background: #28a745;
      color: white;
      border-color: #28a745;
      box-shadow: 0 2px 14px #28a74527;
      transform: scale(1.09);
    }
    .slot.reserved {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
      text-decoration: line-through;
      cursor: not-allowed;
      opacity: 0.65;
      box-shadow: 0 2px 14px #dc354527;
    }
    .actions {
      margin-top: 28px;
      text-align: right;
    }
    .status {
      margin-top: 22px;
      padding: 12px;
      border-radius: 6px;
      display: none;
    }
    .status.success {
      background-color: #e0f9e2;
      color: #116b34;
      border: 1.5px solid #94e2a8;
      font-size: 16px;
    }
    .status.error {
      background-color: #fbe4e6;
      color: #a10026;
      border: 1.5px solid #e39596;
      font-size: 16px;
    }
    .websocket-status {
      padding: 8px 13px;
      border-radius: 5px;
      margin-left: 10px;
      font-size: 13px;
      display: inline-block;
    }
    .connected {
      background-color: #e7fbe7;
      color: #1c8d2e;
      border: 1.5px solid #51db7c;
    }
    .disconnected {
      background-color: #fff0f2;
      color: #a10020;
      border: 1.5px solid #e39596;
    }
    /* Modal styles */
    .modal { 
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); 
      display: none; 
      z-index: 9999;
    }
    .modal-content { 
      background: white; 
      margin: 10% auto; 
      padding: 42px 24px 24px 24px; 
      width: 340px; 
      border-radius: 14px; 
      text-align: center; 
      box-shadow: 0 12px 40px rgba(0,0,0,0.10);
      border-top: 6px solid #4285f4;
      animation: modalSlideIn 0.34s;
    }
    @keyframes modalSlideIn {
      from { transform: scale(0.96) translateY(-25px);}
      to { transform: scale(1) translateY(0);}
    }
    .modal-content button {
      margin: 8px;
      min-width: 100px;
      font-size: 16px;
    }
    @media (max-width: 600px) {
      .container {
        max-width: 99vw;
        padding: 2vw 1vw 8vw 1vw;
      }
      .modal-content { width: 97vw; }
      .slots-container { padding: 10px 3vw 6px 3vw; }
      .slot { font-size: 15px; padding: 12px 6vw;}
    }
  </style>
</head>
<body>
  
  <div class="container">
      <button id="backBtn" style="margin-bottom:18px;background:#e3e6ea;color:#1976d2;border:1.5px solid #1976d2;">&#8592; Back</button>

    <div class="step-title">Book a Doctor's Appointment</div>
    
    <div id="userInfo" class="user-info">
      <h3>Loading user information...</h3>
    </div>
    <div id="bookingFor" class="booking-for" style="display: none;">
      <strong>Booking appointment for:</strong> <span id="patientName"></span>
    </div>
    
    <div class="form-group">
      <label for="doctorSelect">Select Doctor:</label>
      <select id="doctorSelect">
        <option value="">Loading doctors...</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="dateInput">Pick a Date:</label>
      <input id="dateInput" type="date" />
    </div>
    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
      <button id="loadSlotsBtn">See Available Slots</button>
      <span id="wsStatus" class="websocket-status disconnected">Not Connected</span>
    </div>
    <div class="slots-container">
      <h3 style="font-weight:700;font-size:20px;margin:2px 0 14px 0;color:#1976d2;letter-spacing:0.1em;">Available Slots</h3>
      <div id="slotsContainer">
        <p style="font-size:17px;color:#888;margin-top:13px;">Select a doctor and date to view slots</p>
      </div>
    </div>
    <div class="actions">
      <button id="reserveBtn" disabled>Reserve Selected Slot</button>
      <button id="confirmBtn" disabled>Confirm Reservation</button>
      <button id="cancelBtn" disabled>Cancel Reservation</button>
    </div>
    <div id="statusMessage" class="status"></div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <p style="font-size:18px;font-weight:700;margin-bottom:22px;">
        Slot <span id="modalTime"></span> is reserved for you.<br>What would you like to do?
      </p>
      <button id="modalConfirmBtn">Confirm Booking</button>
      <button id="modalCancelBtn">Cancel Reservation</button>
      <button id="modalCloseBtn" style="color:#444;background:#e3e6ea;">Close</button>
    </div>
  </div>
  <script src="config.js"></script>
  <script>
    // Environment-aware API URL
  
    const API_BASE_URL = API_CONFIG.getApiBaseUrl();
    const API_BASE_URL_WS = window.location.hostname.includes('azurewebsites.net') 
      ? window.location.host 
      : "localhost:8000";

    const token = sessionStorage.getItem("token") || localStorage.getItem("token");
    
    if (!token) {
      alert("You must be logged in!");
      window.location.href = "login.html";
    }

    let wsConnection = null;
    let selectedSlot = null;
    let selectedDoctorId = null;
    let selectedDate = null;
    let currentUser = null;
    let bookingForPatient = null; // For family members booking for patients
    let ownReservedKey = null;

    // DOM elements
    const slotsContainer = document.getElementById('slotsContainer');
    const doctorSelect = document.getElementById('doctorSelect');
    const dateInput = document.getElementById('dateInput');
    const loadSlotsBtn = document.getElementById('loadSlotsBtn');
    const reserveBtn = document.getElementById('reserveBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const statusMessage = document.getElementById('statusMessage');
    const wsStatus = document.getElementById('wsStatus');
    const userInfo = document.getElementById('userInfo');
    const bookingForDiv = document.getElementById('bookingFor');
    const patientNameSpan = document.getElementById('patientName');

    // Modal elements
    const modal = document.getElementById('confirmModal');
    const modalTime = document.getElementById('modalTime');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');

    // Set default date to today
    const today = new Date();
    dateInput.value = today.toISOString().split('T')[0];

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCurrentUser();
      await loadDoctors();
      checkForFamilyBooking();
    });

    document.getElementById('backBtn').onclick = function() {
  window.history.back();
};


    function showStatus(message, isError = false) {
      statusMessage.textContent = message;
      statusMessage.className = `status ${isError ? 'error' : 'success'}`;
      statusMessage.style.display = 'block';
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    async function fetchWithAuth(url, options = {}) {
      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      };
      
      try {
        const response = await fetch(url, { ...options, headers: defaultOptions.headers });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `HTTP ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        showStatus(`Error: ${error.message}`, true);
        throw error;
      }
    }

    async function loadCurrentUser() {
      try {
        currentUser = await fetchWithAuth(`${API_BASE_URL}/user/me`);
        
        userInfo.innerHTML = `
          <h3>👤 ${currentUser.name}</h3>
          <p><strong>Email:</strong> ${currentUser.email}</p>
          <p><strong>Role:</strong> ${currentUser.role}</p>
        `;
      } catch (error) {
        console.error('Failed to load user:', error);
        userInfo.innerHTML = '<h3>❌ Failed to load user information</h3>';
      }
    }

    async function loadDoctors() {
      try {
        const doctors = await fetchWithAuth(`${API_BASE_URL}/all_doctors`);
        
        doctorSelect.innerHTML = '<option value="">-- Select Doctor --</option>';
        doctors.forEach(doctor => {
          const option = document.createElement('option');
          option.value = doctor.id;
          option.textContent = `Dr. ${doctor.name}${doctor.medical_license ? ' (' + doctor.medical_license + ')' : ''}`;
          doctorSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load doctors:', error);
        doctorSelect.innerHTML = '<option value="">❌ Failed to load doctors</option>';
      }
    }

    function checkForFamilyBooking() {
      const bookingData = sessionStorage.getItem('bookingForPatient');
      if (bookingData) {
        try {
          bookingForPatient = JSON.parse(bookingData);
          bookingForDiv.style.display = 'block';
          patientNameSpan.textContent = bookingForPatient.patientName;
          
          // Clear the session storage
          sessionStorage.removeItem('bookingForPatient');
        } catch (error) {
          console.error('Error parsing booking data:', error);
        }
      }
    }

    function createSlotElement(time) {
      const el = document.createElement('div');
      el.textContent = time;
      el.className = 'slot';
      el.dataset.time = time;
      const key = `${selectedDoctorId}:${selectedDate}T${time}`;
      el.dataset.key = key;
      el.onclick = () => handleSlotClick(el, key);
      return el;
    }

    async function loadSlots() {
      selectedDoctorId = parseInt(doctorSelect.value);
      selectedDate = dateInput.value;

      if (!selectedDoctorId || !selectedDate) {
        showStatus('Please select a doctor and date', true);
        return;
      }

      try {
        const url = `${API_BASE_URL}/available_appointment?doctor_id=${selectedDoctorId}&app_date=${selectedDate}`;
        const slots = await fetchWithAuth(url);

        slotsContainer.innerHTML = "";
        selectedSlot = null;
        ownReservedKey = null;
        disableActionButtons();

        if (slots.length === 0) {
          slotsContainer.innerHTML += "<p>No slots available for this date</p>";
        } else {
          slots.forEach(time => {
            const slotEl = createSlotElement(time);
            slotsContainer.appendChild(slotEl);
          });
        }

        setupWebSocket(selectedDoctorId);
        showStatus(`Loaded ${slots.length} available slots`);
      } catch (error) {
        console.error('Failed to load slots:', error);
      }
    }

    function setupWebSocket(doctorId) {
      if (wsConnection) {
        wsConnection.close();
      }

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${API_BASE_URL_WS}/ws/doctor/${doctorId}/slots`;

      wsConnection = new WebSocket(wsUrl);

      wsConnection.onopen = () => {
        wsStatus.textContent = 'WebSocket: Connected';
        wsStatus.className = 'websocket-status connected';
        console.log('WebSocket connected');
      };

      wsConnection.onclose = () => {
        wsStatus.textContent = 'WebSocket: Disconnected';
        wsStatus.className = 'websocket-status disconnected';
        console.log('WebSocket disconnected');
      };

      wsConnection.onerror = (error) => {
        showStatus('WebSocket connection error', true);
        console.error('WebSocket error:', error);
      };

      wsConnection.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log('WebSocket message:', data);

          if (data.doctor_id !== doctorId) return;

          const slotTime = data.slot_time.substr(11, 8);
          const key = `${doctorId}:${data.slot_time}`;
          const slotEl = [...slotsContainer.children].find(el => el.dataset && el.dataset.time === slotTime);

          if (!slotEl) return;

          if (data.action === "reserved") {
            slotEl.classList.add('reserved');
            if (slotEl === selectedSlot && ownReservedKey !== key) {
              selectedSlot.classList.remove('selected');
              selectedSlot = null;
              disableActionButtons();
            }
            showStatus(`Slot ${slotTime} was reserved by another user`);
          } else if (data.action === "freed") {
            slotEl.classList.remove('reserved');
            showStatus(`Slot ${slotTime} is now available`);
          }
        } catch (error) {
          console.error('Error processing WebSocket message:', error);
        }
      };
    }

    function disableActionButtons() {
      reserveBtn.disabled = true;
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
    }

    function handleSlotClick(el, key) {
      if (el.classList.contains('reserved') && ownReservedKey !== key) {
        showStatus('This slot is already reserved', true);
        return;
      }

      if (ownReservedKey === key) {
        modalTime.textContent = el.dataset.time;
        modal.style.display = 'block';

        modalConfirmBtn.onclick = () => { confirmSlot(); modal.style.display = 'none'; };
        modalCancelBtn.onclick = () => { cancelSlot(); modal.style.display = 'none'; };
        modalCloseBtn.onclick = () => { modal.style.display = 'none'; };
        return;
      }

      if (selectedSlot) selectedSlot.classList.remove('selected');
      el.classList.add('selected');
      selectedSlot = el;

      reserveBtn.disabled = false;
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
    }

    async function reserveSlot() {
      if (!selectedSlot) {
        showStatus('Please select a slot first', true);
        return;
      }

      const appointmentDateTime = `${selectedDate}T${selectedSlot.dataset.time}`;
      const appointment = {
        doctor_id: selectedDoctorId,
        appointment_date: appointmentDateTime
      };

      // Determine user ID: if family booking for patient, use patient ID; otherwise use current user ID
      const userId = bookingForPatient ? bookingForPatient.patientId : currentUser.id;

      try {
        const url = `${API_BASE_URL}/reserve_slot?user_id=${userId}`;
        const result = await fetchWithAuth(url, {
          method: 'POST',
          body: JSON.stringify(appointment)
        });

        ownReservedKey = `${selectedDoctorId}:${appointmentDateTime}`;
        const bookingText = bookingForPatient ? ` for ${bookingForPatient.patientName}` : '';
        showStatus(`Slot reserved${bookingText}! Expires in ${result.expires_in} seconds`);

        selectedSlot.classList.add('reserved');
        selectedSlot.classList.remove('selected');

        modalTime.textContent = selectedSlot.dataset.time;
        modal.style.display = 'block';
        disableActionButtons();

        selectedSlot = null;
      } catch (error) {
        console.error('Failed to reserve slot:', error);
      }
    }

    async function confirmSlot() {
      if (!ownReservedKey) {
        showStatus('No reserved slot to confirm', true);
        return;
      }

      const colonIndex = ownReservedKey.indexOf(':');
      const doctorId = ownReservedKey.substring(0, colonIndex);
      let appointmentDateTime = ownReservedKey.substring(colonIndex + 1);

      // Fix datetime format if needed
      if (appointmentDateTime.length < 19) {
        if (appointmentDateTime.length === 16) {
          appointmentDateTime += ":00";
        } else if (appointmentDateTime.length === 13) {
          appointmentDateTime += ":00:00";
        }
      }

      const appointment = {
        doctor_id: Number(doctorId),
        appointment_date: appointmentDateTime
      };

      const userId = bookingForPatient ? bookingForPatient.patientId : currentUser.id;

      try {
        const url = `${API_BASE_URL}/confirm_slot?user_id=${userId}`;
        await fetchWithAuth(url, {
          method: 'POST',
          body: JSON.stringify(appointment)
        });

        const bookingText = bookingForPatient ? ` for ${bookingForPatient.patientName}` : '';
        showStatus(`Booking confirmed successfully${bookingText}!`);
        ownReservedKey = null;
        modal.style.display = 'none';
        
        // If family member, redirect back to family dashboard
        if (bookingForPatient) {
          setTimeout(() => {
            window.location.href = 'family_dashboard.html';
          }, 2000);
        } else {
          setTimeout(loadSlots, 1000);
        }
      } catch (error) {
        console.error('Failed to confirm slot:', error);
      }
    }

    async function cancelSlot() {
      if (!ownReservedKey) {
        showStatus('No reserved slot to cancel', true);
        return;
      }

      if (!confirm('Are you sure you want to cancel this reservation?')) return;

      const colonIndex = ownReservedKey.indexOf(':');
      const doctorId = ownReservedKey.substring(0, colonIndex);
      const appointmentDateTime = ownReservedKey.substring(colonIndex + 1);
      const userId = bookingForPatient ? bookingForPatient.patientId : currentUser.id;

      try {
        const url = `${API_BASE_URL}/cancel_slot?doctor_id=${doctorId}&slot_time=${encodeURIComponent(appointmentDateTime)}&user_id=${userId}`;
        await fetchWithAuth(url, { method: 'POST' });

        showStatus('Reservation cancelled successfully');
        ownReservedKey = null;
        modal.style.display = 'none';
        setTimeout(loadSlots, 1000);
      } catch (error) {
        console.error('Failed to cancel slot:', error);
      }
    }

    // Event listeners
    loadSlotsBtn.onclick = loadSlots;
    reserveBtn.onclick = reserveSlot;
    confirmBtn.onclick = confirmSlot;
    cancelBtn.onclick = cancelSlot;

    // Close modal when clicking outside
    window.onclick = (event) => {
      if (event.target === modal) modal.style.display = 'none';
    };
  </script>
</body>
</html>
