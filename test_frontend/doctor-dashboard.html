<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - Telehealth Platform</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="#" class="navbar-brand">Telehealth Platform</a>
            <div class="navbar-menu">
                <span id="userName" class="navbar-item">Loading...</span>
                <button class="btn btn-outline btn-sm logout-btn">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Welcome Section -->
            <div class="section">
                <div class="card">
                    <div class="card-body">
                        <h1 class="section-title">Doctor Dashboard</h1>
                        <div id="userInfo" class="text-secondary">
                            <p>Loading user information...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section">
                <h2 class="section-title">Quick Actions</h2>
                <div class="grid grid-4">
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="loadAppointments()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">üìÖ</div>
                            <h3 class="font-semibold mb-2">My Appointments</h3>
                            <p class="text-secondary text-sm">View and manage patient appointments</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="Modal.show('createChatModal')">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">üí¨</div>
                            <h3 class="font-semibold mb-2">Create Chat Room</h3>
                            <p class="text-secondary text-sm">Start a conversation with patients</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="loadMyChats()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">üí≠</div>
                            <h3 class="font-semibold mb-2">My Chats</h3>
                            <p class="text-secondary text-sm">View all chat rooms</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="Modal.show('addVitalModal')">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">‚ù§Ô∏è</div>
                            <h3 class="font-semibold mb-2">Add Patient Vitals</h3>
                            <p class="text-secondary text-sm">Record patient health data</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointments Section -->
            <div class="section">
                <div class="card">
                    <div class="card-header">
                        <h3 class="font-semibold">Today's Appointments</h3>
                        <button class="btn btn-primary btn-sm" onclick="loadAppointments()">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="appointmentsList">
                            <div class="text-center py-4">
                                <div class="spinner mx-auto mb-2"></div>
                                Loading appointments...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Patient Management -->
            <div class="section">
                <h2 class="section-title">Patient Management</h2>
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="font-semibold">Recent Patients</h3>
                        </div>
                        <div class="card-body">
                            <div id="recentPatients">
                                <div class="text-center text-secondary py-8">
                                    <div class="text-6xl mb-4">üë•</div>
                                    <p>No recent patients</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="font-semibold">Today's Statistics</h3>
                        </div>
                        <div class="card-body">
                            <div id="todayStats" class="grid grid-2 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-primary" id="totalAppointments">-</div>
                                    <div class="text-sm text-secondary">Total Appointments</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-success" id="completedAppointments">-</div>
                                    <div class="text-sm text-secondary">Completed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Appointments Modal -->
    <div id="appointmentsModal" class="modal-overlay">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">My Appointments</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="fullAppointmentsList">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        Loading appointments...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Chat Room Modal -->
    <div id="createChatModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create Chat Room</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createChatForm">
                    <div class="form-group">
                        <label for="chatRoomName" class="form-label">Room Name</label>
                        <input 
                            type="text" 
                            id="chatRoomName" 
                            name="name" 
                            class="form-input" 
                            placeholder="e.g., Patient Consultation Room"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="participantIds" class="form-label">Participant IDs</label>
                        <input 
                            type="text" 
                            id="participantIds" 
                            name="participant_ids" 
                            class="form-input" 
                            placeholder="e.g., 1,2,3 (comma separated user IDs)"
                            required
                        >
                        <div class="text-sm text-secondary mt-1">
                            Enter patient and family member IDs separated by commas
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="Modal.hide('createChatModal')">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Create Chat Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat Rooms Modal -->
    <div id="chatRoomsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">My Chat Rooms</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="chatRoomsList">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        Loading chat rooms...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vital Modal -->
    <div id="addVitalModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Patient Vitals</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addVitalForm">
                    <div class="form-group">
                        <label for="patientEmail" class="form-label">Patient Email</label>
                        <input 
                            type="email" 
                            id="patientEmail" 
                            name="patient_email" 
                            class="form-input" 
                            placeholder="Enter patient's email address"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="bloodPressure" class="form-label">Blood Pressure (mmHg)</label>
                        <input 
                            type="number" 
                            id="bloodPressure" 
                            name="bp" 
                            class="form-input" 
                            placeholder="e.g., 120"
                            min="70"
                            max="200"
                            required
                        >
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="Modal.hide('addVitalModal')">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Add Vital Signs
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentUser = null;
        let appointments = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadAppointments();
        });

        // Load user information
        async function loadUserInfo() {
            try {
                currentUser = await APIService.getCurrentUser();
                
                document.getElementById('userName').textContent = `Dr. ${currentUser.name}`;
                document.getElementById('userInfo').innerHTML = `
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Role:</strong> Doctor</p>
                    <p><strong>Medical License:</strong> ${currentUser.medical_license || 'Not provided'}</p>
                `;
            } catch (error) {
                console.error('Failed to load user info:', error);
                Utils.showNotification('Failed to load user information', 'error');
            }
        }

        // Load appointments
        async function loadAppointments(showModal = false) {
            try {
                appointments = await APIService.getDoctorAppointments();
                
                const todayAppointments = appointments.filter(apt => {
                    const aptDate = new Date(apt.start);
                    const today = new Date();
                    return aptDate.toDateString() === today.toDateString();
                });
                
                // Update today's appointments in main dashboard
                const container = document.getElementById('appointmentsList');
                if (todayAppointments.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-secondary py-8">
                            <div class="text-6xl mb-4">üìÖ</div>
                            <p>No appointments for today</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = todayAppointments.map(appointment => `
                        <div class="border border-gray-200 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-semibold">${appointment.title}</h4>
                                    <p class="text-sm text-secondary">
                                        ${Utils.formatDate(appointment.start)}
                                    </p>
                                </div>
                                <span class="status-badge status-${appointment.status}">
                                    ${appointment.status}
                                </span>
                            </div>
                            ${appointment.status === 'pending' ? `
                                <div class="flex gap-2">
                                    <button class="btn btn-success btn-sm" 
                                            onclick="respondToAppointment(${appointment.id}, 'accept')">
                                        Accept
                                    </button>
                                    <button class="btn btn-error btn-sm" 
                                            onclick="respondToAppointment(${appointment.id}, 'reject')">
                                        Reject
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                // Update statistics
                const totalAppointments = appointments.length;
                const completedAppointments = appointments.filter(apt => apt.status === 'accepted').length;
                
                document.getElementById('totalAppointments').textContent = totalAppointments;
                document.getElementById('completedAppointments').textContent = completedAppointments;
                
                // Update full appointments list if modal is shown
                if (showModal) {
                    Modal.show('appointmentsModal');
                    const fullContainer = document.getElementById('fullAppointmentsList');
                    
                    if (appointments.length === 0) {
                        fullContainer.innerHTML = `
                            <div class="text-center text-secondary py-8">
                                <div class="text-6xl mb-4">üìÖ</div>
                                <p>No appointments found</p>
                            </div>
                        `;
                    } else {
                        fullContainer.innerHTML = `
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Patient</th>
                                            <th>Date & Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${appointments.map(appointment => `
                                            <tr>
                                                <td>${appointment.title}</td>
                                                <td>${Utils.formatDate(appointment.start)}</td>
                                                <td>
                                                    <span class="status-badge status-${appointment.status}">
                                                        ${appointment.status}
                                                    </span>
                                                </td>
                                                <td>
                                                    ${appointment.status === 'pending' ? `
                                                        <div class="flex gap-1">
                                                            <button class="btn btn-success btn-sm" 
                                                                    onclick="respondToAppointment(${appointment.id}, 'accept')">
                                                                Accept
                                                            </button>
                                                            <button class="btn btn-error btn-sm" 
                                                                    onclick="respondToAppointment(${appointment.id}, 'reject')">
                                                                Reject
                                                            </button>
                                                        </div>
                                                    ` : '-'}
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Failed to load appointments:', error);
                document.getElementById('appointmentsList').innerHTML = `
                    <div class="text-center text-error py-4">
                        <p>Failed to load appointments</p>
                    </div>
                `;
            }
        }

        // Respond to appointment
        async function respondToAppointment(appointmentId, action) {
            try {
                await APIService.respondToAppointment(appointmentId, action);
                Utils.showNotification(`Appointment ${action}ed successfully!`, 'success');
                await loadAppointments();
            } catch (error) {
                console.error('Failed to respond to appointment:', error);
                Utils.showNotification(error.message || 'Failed to respond to appointment', 'error');
            }
        }

        // Create chat room
        document.getElementById('createChatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const participantIdsStr = formData.get('participant_ids');
            
            // Parse participant IDs
            const participantIds = participantIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            
            if (participantIds.length === 0) {
                Utils.showNotification('Please enter valid participant IDs', 'error');
                return;
            }
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const stopLoading = Utils.showLoading(submitButton);
            
            try {
                await APIService.createChat(name, participantIds);
                Utils.showNotification('Chat room created successfully!', 'success');
                Modal.hide('createChatModal');
                e.target.reset();
            } catch (error) {
                console.error('Failed to create chat room:', error);
                Utils.showNotification(error.message || 'Failed to create chat room', 'error');
            } finally {
                stopLoading();
            }
        });

        // Load my chats
        async function loadMyChats() {
            try {
                Modal.show('chatRoomsModal');
                const chatRooms = await APIService.getMyChats();
                const container = document.getElementById('chatRoomsList');
                
                if (chatRooms.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-secondary py-8">
                            <div class="text-6xl mb-4">üí¨</div>
                            <p>No chat rooms available</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = chatRooms.map(room => `
                        <div class="border border-gray-200 rounded-lg p-4 mb-4 cursor-pointer hover:bg-gray-50" 
                             onclick="openChat(${room.id})">
                            <h4 class="font-semibold">${room.name}</h4>
                            <p class="text-sm text-secondary">Click to join chat</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load chat rooms:', error);
                document.getElementById('chatRoomsList').innerHTML = `
                    <div class="text-center text-error py-4">
                        <p>Failed to load chat rooms</p>
                    </div>
                `;
            }
        }

        // Open chat
        function openChat(chatId) {
            window.open(`chat.html?chatId=${chatId}`, '_blank');
        }

        // Add patient vital
        document.getElementById('addVitalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const patientEmail = formData.get('patient_email');
            const bp = parseInt(formData.get('bp'));
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const stopLoading = Utils.showLoading(submitButton);
            
            try {
                await APIService.addVital(patientEmail, bp);
                Utils.showNotification('Patient vitals added successfully!', 'success');
                Modal.hide('addVitalModal');
                e.target.reset();
            } catch (error) {
                console.error('Failed to add vital signs:', error);
                Utils.showNotification(error.message || 'Failed to add vital signs', 'error');
            } finally {
                stopLoading();
            }
        });

        // Load appointments when appointments modal is opened
        document.querySelector('[onclick="loadAppointments()"]').addEventListener('click', () => {
            loadAppointments(true);
        });
    </script>
</body>
</html>