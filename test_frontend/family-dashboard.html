<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Dashboard - Telehealth Platform</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="#" class="navbar-brand">Telehealth Platform</a>
            <div class="navbar-menu">
                <span id="userName" class="navbar-item">Loading...</span>
                <button class="btn btn-outline btn-sm logout-btn">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Welcome Section -->
            <div class="section">
                <div class="card">
                    <div class="card-body">
                        <h1 class="section-title">Family Member Dashboard</h1>
                        <div id="userInfo" class="text-secondary">
                            <p>Loading user information...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section">
                <h2 class="section-title">Quick Actions</h2>
                <div class="grid grid-3">
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="loadMyChats()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">üí¨</div>
                            <h3 class="font-semibold mb-2">My Chats</h3>
                            <p class="text-secondary text-sm">View conversations with doctors</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="loadRelatedMembers()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <h3 class="font-semibold mb-2">Family Connections</h3>
                            <p class="text-secondary text-sm">View connected family members</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="loadPendingInvitations()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">üìß</div>
                            <h3 class="font-semibold mb-2">Invitations</h3>
                            <p class="text-secondary text-sm">Manage family invitations</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Family Connections -->
            <div class="section">
                <h2 class="section-title">My Family Connections</h2>
                <div class="card">
                    <div class="card-header">
                        <h3 class="font-semibold">Connected Family Members</h3>
                        <button class="btn btn-primary btn-sm" onclick="loadRelatedMembers()">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="relatedMembersList">
                            <div class="text-center py-4">
                                <div class="spinner mx-auto mb-2"></div>
                                Loading family connections...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Invitations -->
            <div class="section">
                <h2 class="section-title">Pending Invitations</h2>
                <div class="card">
                    <div class="card-header">
                        <h3 class="font-semibold">Invitations Received</h3>
                        <button class="btn btn-primary btn-sm" onclick="loadPendingInvitations()">Refresh</button>
                    </div>
                    <div class="card-body">
                        <div id="pendingInvitationsList">
                            <div class="text-center py-4">
                                <div class="spinner mx-auto mb-2"></div>
                                Loading invitations...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send Invitation Section -->
            <div class="section">
                <h2 class="section-title">Send Family Invitation</h2>
                <div class="card">
                    <div class="card-body">
                        <p class="text-secondary mb-4">
                            Invite another family member to connect and access your health information.
                        </p>
                        <form id="inviteFamilyForm" class="grid grid-2 gap-4">
                            <div class="form-group">
                                <label for="inviteeEmail" class="form-label">Family Member's Email</label>
                                <input 
                                    type="email" 
                                    id="inviteeEmail" 
                                    name="invitee_email" 
                                    class="form-input" 
                                    placeholder="Enter email address"
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="relationshipType" class="form-label">Relationship</label>
                                <select id="relationshipType" name="relationship_type" class="form-select" required>
                                    <option value="">Select relationship</option>
                                    <option value="spouse">Spouse</option>
                                    <option value="parent">Parent</option>
                                    <option value="sibling">Sibling</option>
                                </select>
                            </div>
                            
                            <div class="col-span-2">
                                <button type="submit" class="btn btn-primary">
                                    Send Invitation
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Health Information Access -->
            <div class="section">
                <h2 class="section-title">Health Information Access</h2>
                <div class="card">
                    <div class="card-body">
                        <div id="healthAccessInfo">
                            <div class="text-center text-secondary py-8">
                                <div class="text-6xl mb-4">üè•</div>
                                <p>Connect with family members to access their health information</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Chat Rooms Modal -->
    <div id="chatRoomsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">My Chat Rooms</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="chatRoomsList">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        Loading chat rooms...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Members Modal -->
    <div id="relatedMembersModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Related Family Members</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="relatedMembersContent">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        Loading related members...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invitations Modal -->
    <div id="invitationsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Family Invitations</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invitationsContent">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        Loading invitations...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadRelatedMembers();
            await loadPendingInvitations();
        });

        // Load user information
        async function loadUserInfo() {
            try {
                currentUser = await APIService.getCurrentUser();
                
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userInfo').innerHTML = `
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Role:</strong> Family Member</p>
                    <p><strong>Member since:</strong> ${Utils.formatDate(currentUser.date_of_birth)}</p>
                `;
            } catch (error) {
                console.error('Failed to load user info:', error);
                Utils.showNotification('Failed to load user information', 'error');
            }
        }

        // Load related family members
        async function loadRelatedMembers(showModal = false) {
            try {
                const relatedMembers = await APIService.getRelatedFamilyMembers();
                const container = document.getElementById('relatedMembersList');
                const modalContainer = document.getElementById('relatedMembersContent');
                
                const renderContent = (members, targetContainer) => {
                    if (members.length === 0) {
                        targetContainer.innerHTML = `
                            <div class="text-center text-secondary py-8">
                                <div class="text-6xl mb-4">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                                <p>No family connections yet</p>
                                <p class="text-sm">Send invitations to connect with family members</p>
                            </div>
                        `;
                    } else {
                        targetContainer.innerHTML = members.map(member => `
                            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-semibold">${member.name}</h4>
                                        <p class="text-sm text-secondary">${member.email}</p>
                                        <p class="text-sm text-secondary capitalize">
                                            Relationship: ${member.relationship_type}
                                        </p>
                                    </div>
                                    <div class="text-success">
                                        Connected
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                };
                
                renderContent(relatedMembers, container);
                
                if (showModal) {
                    Modal.show('relatedMembersModal');
                    renderContent(relatedMembers, modalContainer);
                }
                
            } catch (error) {
                console.error('Failed to load related members:', error);
                const errorMessage = `
                    <div class="text-center text-error py-4">
                        <p>Failed to load family connections</p>
                    </div>
                `;
                document.getElementById('relatedMembersList').innerHTML = errorMessage;
                if (showModal) {
                    document.getElementById('relatedMembersContent').innerHTML = errorMessage;
                }
            }
        }

        // Load pending invitations
        async function loadPendingInvitations(showModal = false) {
            try {
                const invitations = await APIService.getFamilyInvitations();
                const container = document.getElementById('pendingInvitationsList');
                const modalContainer = document.getElementById('invitationsContent');
                
                const renderContent = (invitations, targetContainer) => {
                    if (invitations.length === 0) {
                        targetContainer.innerHTML = `
                            <div class="text-center text-secondary py-8">
                                <div class="text-6xl mb-4">üì™</div>
                                <p>No pending invitations</p>
                            </div>
                        `;
                    } else {
                        targetContainer.innerHTML = invitations.map(invitation => `
                            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold">${invitation.inviter_name}</h4>
                                        <p class="text-sm text-secondary capitalize">
                                            Wants to connect as ${invitation.relationship_type}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-success btn-sm" 
                                            onclick="respondToInvitation('${invitation.token}', 'accept')">
                                        Accept
                                    </button>
                                    <button class="btn btn-error btn-sm" 
                                            onclick="respondToInvitation('${invitation.token}', 'reject')">
                                        Reject
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                };
                
                renderContent(invitations, container);
                
                if (showModal) {
                    Modal.show('invitationsModal');
                    renderContent(invitations, modalContainer);
                }
                
            } catch (error) {
                console.error('Failed to load pending invitations:', error);
                const errorMessage = `
                    <div class="text-center text-error py-4">
                        <p>Failed to load invitations</p>
                    </div>
                `;
                document.getElementById('pendingInvitationsList').innerHTML = errorMessage;
                if (showModal) {
                    document.getElementById('invitationsContent').innerHTML = errorMessage;
                }
            }
        }

        // Respond to invitation
        async function respondToInvitation(token, action) {
            try {
                await APIService.respondToInvitation(token, action);
                Utils.showNotification(`Invitation ${action}ed successfully!`, 'success');
                await loadPendingInvitations();
                await loadRelatedMembers();
            } catch (error) {
                console.error('Failed to respond to invitation:', error);
                Utils.showNotification(error.message || 'Failed to respond to invitation', 'error');
            }
        }

        // Send family invitation
        document.getElementById('inviteFamilyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const inviteeEmail = formData.get('invitee_email');
            const relationshipType = formData.get('relationship_type');
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const stopLoading = Utils.showLoading(submitButton);
            
            try {
                await APIService.sendInvitation(inviteeEmail, relationshipType);
                Utils.showNotification('Invitation sent successfully!', 'success');
                e.target.reset();
                await loadRelatedMembers();
            } catch (error) {
                console.error('Failed to send invitation:', error);
                Utils.showNotification(error.message || 'Failed to send invitation', 'error');
            } finally {
                stopLoading();
            }
        });

        // Load my chats
        async function loadMyChats() {
            try {
                Modal.show('chatRoomsModal');
                const chatRooms = await APIService.getMyChats();
                const container = document.getElementById('chatRoomsList');
                
                if (chatRooms.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-secondary py-8">
                            <div class="text-6xl mb-4">üí¨</div>
                            <p>No chat rooms available</p>
                            <p class="text-sm">Doctors can create chat rooms and invite you</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = chatRooms.map(room => `
                        <div class="border border-gray-200 rounded-lg p-4 mb-4 cursor-pointer hover:bg-gray-50" 
                             onclick="openChat(${room.id})">
                            <h4 class="font-semibold">${room.name}</h4>
                            <p class="text-sm text-secondary">Click to join chat</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load chat rooms:', error);
                document.getElementById('chatRoomsList').innerHTML = `
                    <div class="text-center text-error py-4">
                        <p>Failed to load chat rooms</p>
                    </div>
                `;
            }
        }

        // Open chat
        function openChat(chatId) {
            window.open(`chat.html?chatId=${chatId}`, '_blank');
        }

        // Update health access info based on connections
        async function updateHealthAccessInfo() {
            try {
                const relatedMembers = await APIService.getRelatedFamilyMembers();
                const container = document.getElementById('healthAccessInfo');
                
                if (relatedMembers.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-secondary py-8">
                            <div class="text-6xl mb-4">üè•</div>
                            <p>Connect with family members to access their health information</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="space-y-4">
                            <h4 class="font-semibold mb-3">You have access to health information for:</h4>
                            ${relatedMembers.map(member => `
                                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                                    <div>
                                        <div class="font-medium">${member.name}</div>
                                        <div class="text-sm text-secondary capitalize">${member.relationship_type}</div>
                                    </div>
                                    <div class="text-success text-sm">
                                        Access Granted
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to update health access info:', error);
            }
        }

        // Update health access info when page loads
        setTimeout(updateHealthAccessInfo, 1000);
    </script>

    <style>
        .col-span-2 {
            grid-column: span 2;
        }
    </style>
</body>
</html>