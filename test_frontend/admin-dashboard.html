<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Telehealth Platform</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="#" class="navbar-brand">Telehealth Platform</a>
            <div class="navbar-menu">
                <span id="userName" class="navbar-item">Loading...</span>
                <button class="btn btn-outline btn-sm logout-btn">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Welcome Section -->
            <div class="section">
                <div class="card">
                    <div class="card-body">
                        <h1 class="section-title">Admin Dashboard</h1>
                        <div id="userInfo" class="text-secondary">
                            <p>Loading user information...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section">
                <h2 class="section-title">Administration Tools</h2>
                <div class="grid grid-4">
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="loadAllUsers()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">ðŸ‘¥</div>
                            <h3 class="font-semibold mb-2">Manage Users</h3>
                            <p class="text-secondary text-sm">View and manage all platform users</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="loadAllChats()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">ðŸ’¬</div>
                            <h3 class="font-semibold mb-2">Chat Rooms</h3>
                            <p class="text-secondary text-sm">Manage all chat rooms</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="Modal.show('createRoomModal')">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">âž•</div>
                            <h3 class="font-semibold mb-2">Create Chat Room</h3>
                            <p class="text-secondary text-sm">Create room between doctor and patient</p>
                        </div>
                    </div>
                    
                    <div class="card cursor-pointer hover:shadow-md transition" onclick="showSystemStats()">
                        <div class="card-body text-center">
                            <div class="text-3xl mb-3">ðŸ“Š</div>
                            <h3 class="font-semibold mb-2">System Statistics</h3>
                            <p class="text-secondary text-sm">View platform usage statistics</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Statistics -->
            <div class="section">
                <h2 class="section-title">Platform Overview</h2>
                <div class="grid grid-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-2xl font-bold text-primary" id="totalUsers">-</div>
                            <div class="text-sm text-secondary">Total Users</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-2xl font-bold text-success" id="totalDoctors">-</div>
                            <div class="text-sm text-secondary">Doctors</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-2xl font-bold text-warning" id="totalPatients">-</div>
                            <div class="text-sm text-secondary">Patients</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="text-2xl font-bold text-info" id="totalChatRooms">-</div>
                            <div class="text-sm text-secondary">Chat Rooms</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="section">
                <h2 class="section-title">Recent Activity</h2>
                <div class="card">
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="text-center text-secondary py-8">
                                <div class="text-6xl mb-4">ðŸ“‹</div>
                                <p>System monitoring and activity logs would appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Users Management Modal -->
    <div id="usersModal" class="modal-overlay">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Users</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="usersList">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        Loading users...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Rooms Management Modal -->
    <div id="chatRoomsModal" class="modal-overlay">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Chat Rooms</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="chatRoomsList">
                    <div class="text-center py-4">
                        <div class="spinner mx-auto mb-2"></div>
                        Loading chat rooms...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div id="createRoomModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create Chat Room</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createRoomForm">
                    <div class="form-group">
                        <label for="doctorId" class="form-label">Doctor ID</label>
                        <input 
                            type="number" 
                            id="doctorId" 
                            name="doctor_id" 
                            class="form-input" 
                            placeholder="Enter doctor's user ID"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="patientId" class="form-label">Patient ID</label>
                        <input 
                            type="number" 
                            id="patientId" 
                            name="patient_id" 
                            class="form-input" 
                            placeholder="Enter patient's user ID"
                            required
                        >
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="Modal.hide('createRoomModal')">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Create Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- System Stats Modal -->
    <div id="systemStatsModal" class="modal-overlay">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">System Statistics</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="systemStatsContent">
                    <div class="grid grid-2 gap-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="font-semibold mb-2">User Distribution</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Patients:</span>
                                        <span id="statPatients">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Doctors:</span>
                                        <span id="statDoctors">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Family:</span>
                                        <span id="statFamily">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Admins:</span>
                                        <span id="statAdmins">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="font-semibold mb-2">Platform Activity</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Total Chat Rooms:</span>
                                        <span id="statTotalChats">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Active Sessions:</span>
                                        <span class="text-success">Online</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>System Status:</span>
                                        <span class="text-success">Healthy</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentUser = null;
        let allUsers = [];
        let allChatRooms = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
            await loadSystemStats();
        });

        // Load user information
        async function loadUserInfo() {
            try {
                currentUser = await APIService.getCurrentUser();
                
                document.getElementById('userName').textContent = `Admin: ${currentUser.name}`;
                document.getElementById('userInfo').innerHTML = `
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Role:</strong> Administrator</p>
                    <p><strong>Access Level:</strong> Full System Access</p>
                `;
            } catch (error) {
                console.error('Failed to load user info:', error);
                Utils.showNotification('Failed to load user information', 'error');
            }
        }

        // Load system statistics
        async function loadSystemStats() {
            try {
                const users = await APIService.getAllUsers();
                
                const userStats = users.reduce((stats, user) => {
                    stats[user.role] = (stats[user.role] || 0) + 1;
                    return stats;
                }, {});
                
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalDoctors').textContent = userStats.doctor || 0;
                document.getElementById('totalPatients').textContent = userStats.patient || 0;
                
                // Try to load chat rooms count
                try {
                    const chatRooms = await APIService.adminGetAllChats();
                    document.getElementById('totalChatRooms').textContent = chatRooms.length;
                } catch (error) {
                    document.getElementById('totalChatRooms').textContent = 'N/A';
                }
                
            } catch (error) {
                console.error('Failed to load system stats:', error);
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('totalDoctors').textContent = 'Error';
                document.getElementById('totalPatients').textContent = 'Error';
                document.getElementById('totalChatRooms').textContent = 'Error';
            }
        }

        // Load all users
        async function loadAllUsers() {
            try {
                Modal.show('usersModal');
                allUsers = await APIService.getAllUsers();
                const container = document.getElementById('usersList');
                
                if (allUsers.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-secondary py-8">
                            <div class="text-6xl mb-4">ðŸ‘¥</div>
                            <p>No users found</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>License</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allUsers.map(user => `
                                        <tr>
                                            <td>${user.id}</td>
                                            <td>${user.name}</td>
                                            <td>${user.email}</td>
                                            <td>
                                                <span class="status-badge status-${user.role === 'admin' ? 'accepted' : 'pending'}">
                                                    ${user.role}
                                                </span>
                                            </td>
                                            <td>${user.medical_license || '-'}</td>
                                            <td>
                                                ${user.id !== currentUser.id ? `
                                                    <button class="btn btn-error btn-sm" 
                                                            onclick="deleteUser(${user.id}, '${user.name}')"
                                                            title="Delete User">
                                                        Delete
                                                    </button>
                                                ` : '<span class="text-secondary text-sm">Current User</span>'}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersList').innerHTML = `
                    <div class="text-center text-error py-4">
                        <p>Failed to load users</p>
                    </div>
                `;
            }
        }

        // Delete user
        async function deleteUser(userId, userName) {
            if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                await APIService.deleteUser(userId);
                Utils.showNotification(`User "${userName}" deleted successfully`, 'success');
                await loadAllUsers();
                await loadSystemStats();
            } catch (error) {
                console.error('Failed to delete user:', error);
                Utils.showNotification(error.message || 'Failed to delete user', 'error');
            }
        }

        // Load all chat rooms
        async function loadAllChats() {
            try {
                Modal.show('chatRoomsModal');
                allChatRooms = await APIService.adminGetAllChats();
                const container = document.getElementById('chatRoomsList');
                
                if (allChatRooms.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-secondary py-8">
                            <div class="text-6xl mb-4">ðŸ’¬</div>
                            <p>No chat rooms found</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Room Name</th>
                                        <th>Created By</th>
                                        <th>Participants</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allChatRooms.map(room => `
                                        <tr>
                                            <td>${room.id}</td>
                                            <td>${room.name}</td>
                                            <td>${room.created_by}</td>
                                            <td>${room.participant_count || 'N/A'}</td>
                                            <td>
                                                <div class="flex gap-1">
                                                    <button class="btn btn-primary btn-sm" 
                                                            onclick="openChat(${room.id})"
                                                            title="Open Chat">
                                                        Open
                                                    </button>
                                                    <button class="btn btn-error btn-sm" 
                                                            onclick="deleteRoom(${room.id}, '${room.name}')"
                                                            title="Delete Room">
                                                        Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load chat rooms:', error);
                document.getElementById('chatRoomsList').innerHTML = `
                    <div class="text-center text-error py-4">
                        <p>Failed to load chat rooms</p>
                    </div>
                `;
            }
        }

        // Delete chat room
        async function deleteRoom(roomId, roomName) {
            if (!confirm(`Are you sure you want to delete chat room "${roomName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                await APIService.adminDeleteRoom(roomId);
                Utils.showNotification(`Chat room "${roomName}" deleted successfully`, 'success');
                await loadAllChats();
                await loadSystemStats();
            } catch (error) {
                console.error('Failed to delete chat room:', error);
                Utils.showNotification(error.message || 'Failed to delete chat room', 'error');
            }
        }

        // Open chat room
        function openChat(chatId) {
            window.open(`chat.html?chatId=${chatId}`, '_blank');
        }

        // Create chat room
        document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const doctorId = parseInt(formData.get('doctor_id'));
            const patientId = parseInt(formData.get('patient_id'));
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const stopLoading = Utils.showLoading(submitButton);
            
            try {
                await APIService.adminCreateRoom(doctorId, patientId);
                Utils.showNotification('Chat room created successfully!', 'success');
                Modal.hide('createRoomModal');
                e.target.reset();
                await loadSystemStats();
            } catch (error) {
                console.error('Failed to create chat room:', error);
                Utils.showNotification(error.message || 'Failed to create chat room', 'error');
            } finally {
                stopLoading();
            }
        });

        // Show system statistics modal
        async function showSystemStats() {
            Modal.show('systemStatsModal');
            
            try {
                const users = await APIService.getAllUsers();
                
                const userStats = users.reduce((stats, user) => {
                    stats[user.role] = (stats[user.role] || 0) + 1;
                    return stats;
                }, {});
                
                document.getElementById('statPatients').textContent = userStats.patient || 0;
                document.getElementById('statDoctors').textContent = userStats.doctor || 0;
                document.getElementById('statFamily').textContent = userStats.family || 0;
                document.getElementById('statAdmins').textContent = userStats.admin || 0;
                
                try {
                    const chatRooms = await APIService.adminGetAllChats();
                    document.getElementById('statTotalChats').textContent = chatRooms.length;
                } catch (error) {
                    document.getElementById('statTotalChats').textContent = 'N/A';
                }
                
            } catch (error) {
                console.error('Failed to load detailed stats:', error);
            }
        }

        // Auto-refresh stats every 30 seconds
        setInterval(loadSystemStats, 30000);
    </script>

    <style>
        .text-info {
            color: #3b82f6;
        }
        
        .flex.gap-1 {
            gap: 4px;
        }
    </style>
</body>
</html>